generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SALES_TEAM
  BUSINESS_EXPERT
  OWNER
}

enum ProposalStatus {
  DRAFT
  IN_REVIEW
  PENDING_APPROVAL
  APPROVED
  REJECTED
  SENT
}

enum Permission {
  VIEW
  EDIT
}

model User {
  id             String   @id @default(cuid())
  email          String   @unique
  password       String
  name           String
  role           Role
  companyName    String?
  phone          String?
  avatarUrl      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  templates      Template[]
  proposals      Proposal[] @relation("CreatedProposals")
  approvedProposals Proposal[] @relation("ApprovedProposals")
  comments       Comment[]
  images         Image[]
  companySetting CompanySetting?
  sharedProposals ProposalShare[] @relation("SharedWith")
  sharedByMe     ProposalShare[] @relation("SharedBy")
  versionChanges VersionHistory[]
}

model Template {
  id          String   @id @default(cuid())
  name        String
  category    String?
  sections    Json
  thumbnailUrl String?
  isActive    Boolean  @default(true)
  createdBy   String?
  creator     User?    @relation(fields: [createdBy], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  proposals   Proposal[]
}

model Proposal {
  id              String   @id @default(cuid())
  title           String
  templateId      String?
  template        Template? @relation(fields: [templateId], references: [id])
  content         Json
  clientName      String?
  clientCompany   String?
  clientEmail     String?
  clientAddress   String?
  clientLogoUrl   String?
  status          ProposalStatus @default(DRAFT)
  createdBy       String
  creator         User           @relation("CreatedProposals", fields: [createdBy], references: [id])
  approvedBy      String?
  approver        User?          @relation("ApprovedProposals", fields: [approvedBy], references: [id])
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  shares          ProposalShare[]
  comments        Comment[]
  pricingItems    PricingItem[]
  images          Image[]
  versions        VersionHistory[]
}

model ProposalShare {
  id                String   @id @default(cuid())
  proposalId        String
  proposal          Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  sharedWithUserId  String
  sharedWith        User     @relation("SharedWith", fields: [sharedWithUserId], references: [id])
  permission        Permission @default(VIEW)
  sharedById        String
  sharedBy          User     @relation("SharedBy", fields: [sharedById], references: [id])
  sharedAt          DateTime @default(now())

  @@unique([proposalId, sharedWithUserId])
}

model Comment {
  id                String   @id @default(cuid())
  proposalId        String
  proposal          Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  sectionId         String?
  content           String
  parentCommentId   String?
  parentComment     Comment? @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies           Comment[] @relation("CommentReplies")
  isResolved        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PricingItem {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  serviceDescription String
  cost            Float
  frequency       String?
  orderIndex      Int?
  createdAt       DateTime @default(now())
}

model Image {
  id          String   @id @default(cuid())
  proposalId  String?
  proposal    Proposal? @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  url         String
  filename    String?
  fileSize    Int?
  imageType   String?
  uploadedBy  String?
  uploader    User?    @relation(fields: [uploadedBy], references: [id])
  uploadedAt  DateTime @default(now())
}

model VersionHistory {
  id              String   @id @default(cuid())
  proposalId      String
  proposal        Proposal @relation(fields: [proposalId], references: [id], onDelete: Cascade)
  contentSnapshot Json
  changedBy       String?
  changer         User?    @relation(fields: [changedBy], references: [id])
  changeDescription String?
  createdAt       DateTime @default(now())
}

model CompanySetting {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  companyName     String?
  logoUrl         String?
  address         String?
  phone           String?
  email           String?
  website         String?
  defaultPaymentTerms String?
  defaultValidityDays Int? @default(30)
  taxRate         Float?  @default(18.0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
